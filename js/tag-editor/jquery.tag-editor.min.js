// jQuery tagEditor v1.0.2
// https://github.com/Pixabay/jQuery-tagEditor
!function(t){t.fn.autoGrowInput=function(e){return e=t.extend({maxWidth:250,minWidth:20,comfortZone:0},e),this.filter("input:text").each(function(){var i=(e.minWidth||t(this).width()," "),a=t(this),n=e.comfortZone?e.comfortZone:parseInt(.9*parseInt(t(this).css("fontSize"))),r=t("<dummy/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:a.css("fontSize"),fontFamily:a.css("fontFamily"),fontWeight:a.css("fontWeight"),letterSpacing:a.css("letterSpacing"),whiteSpace:"nowrap"}),o=function(){if(i!==(i=a.val())){r.html(i.replace(/&/g,"&amp;").replace(/\s/g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));var t=r.width()+n;t>e.maxWidth&&(t=e.maxWidth),t<e.minWidth&&(t=e.minWidth),t!=a.width()&&a.width(t)}};r.insertAfter(a),t(this).bind("keyup keydown blur focus autogrow",o)}),this},!function(t){t.fn.caret=function(t){var e=this[0],i="true"===e.contentEditable;if(0==arguments.length){if(window.getSelection){if(i){e.focus();var a=window.getSelection().getRangeAt(0),n=a.cloneRange();return n.selectNodeContents(e),n.setEnd(a.endContainer,a.endOffset),n.toString().length}return e.selectionStart}if(document.selection){if(e.focus(),i){var a=document.selection.createRange(),n=document.body.createTextRange();return n.moveToElementText(e),n.setEndPoint("EndToEnd",a),n.text.length}var t=0,r=e.createTextRange(),n=document.selection.createRange().duplicate(),o=n.getBookmark();for(r.moveToBookmark(o);0!==r.moveStart("character",-1);)t++;return t}return 0}if(-1==t&&(t=this[i?"text":"val"]().length),window.getSelection)i?(e.focus(),window.getSelection().collapse(e.firstChild,t)):e.setSelectionRange(t,t);else if(document.body.createTextRange)if(i){var r=document.body.createTextRange();r.moveToElementText(e),r.moveStart("character",t),r.collapse(!0),r.select()}else{var r=e.createTextRange();r.move("character",t),r.select()}return i||e.focus(),t}}(jQuery),t.fn.tagEditor=function(e,a,n){function r(e){if(8==e.which||46==e.which||e.ctrlKey&&88==e.which){var a=getSelection(),n=t(a.getRangeAt(0).commonAncestorContainer);if(n.hasClass("tag-editor")){var r=[],o=a.toString().split(n.prev().data("options").dregex);for(i=0;i<o.length;i++){var l=t.trim(o[i]);l&&r.push(l)}return t(".tag-editor-tag",n).each(function(){~t.inArray(t(this).html(),r)&&t(this).closest("li").find(".tag-editor-delete").click()}),!1}}}var o,l=t.extend({},t.fn.tagEditor.defaults,e),c=this;if(l.dregex=new RegExp("["+l.delimiter.replace("-","-")+"]","g"),"string"==typeof e){var s=[];return c.each(function(){var i=t(this),r=i.data("options"),o=i.next(".tag-editor");"getTags"==e?s.push({field:i[0],editor:o,tags:o.data("tags")}):"addTag"==e?(t('<li><div class="tag-editor-spacer">&nbsp;'+r.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>').appendTo(o).find(".tag-editor-tag").html('<input type="text" maxlength="'+r.maxLength+'">').addClass("active").find("input").val(a).blur(),"blur"!=n?o.click():t(".placeholder",o).remove()):"removeTag"==e?(t(".tag-editor-tag",o).filter(function(){return t(this).html()==a}).closest("li").find(".tag-editor-delete").click(),"blur"!=n&&o.click()):"destroy"==e&&i.css("display",r.elDisplay).removeData("options").next(".tag-editor").remove()}),s}return window.getSelection&&t(document).off("keydown.tag-editor").on("keydown.tag-editor",r),c.each(function(){function e(){!l.placeholder||c.length||t(".deleted, .placeholder, input",s).length||s.append('<li class="placeholder"><div>'+l.placeholder+"</div></li>")}function a(i){var a=c.toString();c=t(".tag-editor-tag:not(.deleted)",s).map(function(e,i){var a=t.trim(t(this).hasClass("active")?t(this).find("input").val():t(i).text());return a?a:void 0}).get(),s.data("tags",c),r.val(c.join(l.delimiter[0])),i||a!=c.toString()&&l.onChange(r,s,c),e()}function n(e){var n=e.closest("li"),o=e.val().replace(/ +/," ").split(l.dregex),d=e.data("old_tag"),g=c.slice(0);for(i in o)u=t.trim(o[i]).slice(0,l.maxLength),u&&(l.forceLowercase&&(u=u.toLowerCase()),l.beforeTagSave(r,s,g,d,u),~t.inArray(u,g)&&t(".tag-editor-tag",s).each(function(){t(this).html()==u&&t(this).closest("li").remove()}),g.push(u),n.before('<li><div class="tag-editor-spacer">&nbsp;'+l.delimiter[0]+'</div><div class="tag-editor-tag">'+u+'</div><div class="tag-editor-delete"><i></i></div></li>'));e.attr("maxlength",l.maxLength).removeData("old_tag").val("").focus(),a()}var r=t(this),c=[];l.elDisplay=r.css("display"),r.css("display","none");var s=t("<ul "+(l.clickDelete?'oncontextmenu="return false;" ':"")+'class="tag-editor"></ul>').insertAfter(r);r.data("options",l),s.append('<li style="width:.1px">&nbsp;</li>');var d='<li><div class="tag-editor-spacer">&nbsp;'+l.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>';s.click(function(e){if(!window.getSelection||""==getSelection()){if(o=!0,t("input:focus",s).blur(),!o)return!1;o=!0,t(".placeholder",s).remove();var i,a,n,r=99999;return t(".tag-editor-tag",s).each(function(){var o=t(this),l=o.offset(),c=l.left,s=l.top;e.pageY>=s&&e.pageY<=s+o.height()&&(e.pageX<c?(n="before",i=c-e.pageX):(n="after",i=e.pageX-c-o.width()),r>i&&(r=i,a=o))}),"before"==n?t(d).insertBefore(a.closest("li")).find(".tag-editor-tag").click():"after"==n?t(d).insertAfter(a.closest("li")).find(".tag-editor-tag").click():t(d).appendTo(s).find(".tag-editor-tag").click(),!1}}),s.on("click",".tag-editor-delete",function(){if(t(this).prev().hasClass("active"))return t(this).closest("li").find("input").caret(-1),!1;var i=t(this).closest("li"),n=i.find(".tag-editor-tag");return l.beforeTagDelete(r,s,c,n.html())===!1?!1:(n.addClass("deleted").animate({width:0},175,function(){i.remove(),e()}),a(),!1)}),l.clickDelete&&s.on("mousedown",".tag-editor-tag",function(i){if(i.ctrlKey||i.which>1){var n=t(this).closest("li"),o=n.find(".tag-editor-tag");return l.beforeTagDelete(r,s,c,o.html())===!1?!1:(o.addClass("deleted").animate({width:0},175,function(){n.remove(),e()}),a(),!1)}}),s.on("click",".tag-editor-tag",function(e){if(l.clickDelete&&(e.ctrlKey||e.which>1))return!1;if(!t(this).hasClass("active")){var i=t(this).html(),a=Math.abs((t(this).offset().left-e.pageX)/t(this).width()),n=parseInt(i.length*a),r=t(this).html('<input type="text" maxlength="'+l.maxLength+'" value="'+i+'">').addClass("active").find("input");if(r.data("old_tag",i).focus().autoGrowInput().trigger("autogrow").caret(n),l.autocomplete){var o=l.autocomplete,c="select"in o?l.autocomplete.select:"";o.select=function(){c&&c(),setTimeout(function(){t(".active",s).find("input").trigger("autogrow")},20)},r.autocomplete(o)}}return!1}),s.on("blur","input",function(){var i=t(this),d=i.data("old_tag"),g=t.trim(i.val().replace(/ +/," ").replace(l.dregex,l.delimiter[0]));if(g){if(g.indexOf(l.delimiter[0])>=0)return void n(i);g!=d&&(l.forceLowercase&&(g=g.toLowerCase()),l.beforeTagSave(r,s,c,d,g),t(".tag-editor-tag:not(.active)",s).each(function(){t(this).html()==g&&t(this).closest("li").remove()}))}else{if(d&&l.beforeTagDelete(r,s,c,d)===!1)return i.val(d).trigger("autogrow").focus(),o=!1,void a();try{i.closest("li").remove()}catch(f){}d&&a()}i.parent().html(g).removeClass("active"),g!=d&&a(),e()});var g;s.on("paste","input",function(){t(this).removeAttr("maxlength"),g=t(this),setTimeout(function(){n(g)},30)});var f;s.on("keypress","input",function(e){l.delimiter.indexOf(String.fromCharCode(e.which))>=0&&(f=t(this),setTimeout(function(){n(f)},20))}),s.on("keydown","input",function(e){var i=t(this);if((37==e.which||!l.autocomplete&&38==e.which)&&!i.caret()||8==e.which&&!i.val()){var a=i.closest("li").prev("li").find(".tag-editor-tag");return a.length?a.click().find("input").caret(-1):i.val()&&t(d).insertBefore(i.closest("li")).find(".tag-editor-tag").click(),!1}if((39==e.which||!l.autocomplete&&40==e.which)&&i.caret()==i.val().length){var n=i.closest("li").next("li").find(".tag-editor-tag");return n.length?n.click().find("input").caret(0):i.val()&&s.click(),!1}if(9==e.which){if(e.shiftKey){var a=i.closest("li").prev("li").find(".tag-editor-tag");a.length?a.click().find("input").caret(0):i.val()&&t(d).insertBefore(i.closest("li")).find(".tag-editor-tag").click()}else{var n=i.closest("li").next("li").find(".tag-editor-tag");n.length?n.click().find("input").caret(0):i.val()&&s.click()}return!1}if(!(46!=e.which||t.trim(i.val())&&i.caret()!=i.val().length)){var n=i.closest("li").next("li").find(".tag-editor-tag");return n.length?n.click().find("input").caret(0):i.val()&&s.click(),!1}if(13==e.which){var n=i.closest("li").next("li").find(".tag-editor-tag");return n.length?n.click().find("input").caret(0):i.val()&&s.click(),!1}if(36!=e.which||i.caret()){if(35==e.which&&i.caret()==i.val().length)s.find(".tag-editor-tag").last().click();else if(27==e.which)return i.val(i.data("old_tag")?i.data("old_tag"):"").blur(),!1}else s.find(".tag-editor-tag").first().click()});var h=l.initialTags.length?l.initialTags:r.val().split(l.dregex);for(i in h){var u=t.trim(h[i].replace(/ +/," "));u&&(l.forceLowercase&&(u=u.toLowerCase()),c.push(u),s.append('<li><div class="tag-editor-spacer">&nbsp;'+l.delimiter[0]+'</div><div class="tag-editor-tag">'+u+'</div><div class="tag-editor-delete"><i></i></div></li>'))}a(!0),l.sortable&&t.fn.sortable&&s.sortable({distance:5,cancel:".tag-editor-spacer, input",helper:"clone",update:function(){a()}})})},t.fn.tagEditor.defaults={initialTags:[],maxLength:50,delimiter:",;",placeholder:"",forceLowercase:!0,clickDelete:!1,sortable:!0,autocomplete:null,onChange:function(){},beforeTagSave:function(){},beforeTagDelete:function(){}}}(jQuery);
